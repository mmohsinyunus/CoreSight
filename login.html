<script>
  // CoreSight Auth API (Google Apps Script Web App)
  const API_URL = "https://script.google.com/macros/s/AKfycbx9Qftjb5-4d2XjlK7F3zTlfZnWIBjBGi4iVV-GdabSeqDpzkljewQsElsVt2wbntIQcA/exec";

  const msgBox = document.getElementById("msgBox");

  function showMsg(text, type){
    msgBox.textContent = text;
    msgBox.className = "msg " + (type || "");
    msgBox.style.display = "block";
  }
  function clearMsg(){
    msgBox.style.display = "none";
    msgBox.textContent = "";
    msgBox.className = "msg";
  }

  async function postAPI(body){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    // If Apps Script returns HTML error, this may throw â€” handled in callers
    return await res.json();
  }

  // ---- Modals ----
  const createBack = document.getElementById("createModalBack");
  const forgotBack = document.getElementById("forgotModalBack");

  function openModal(back){ back.style.display = "flex"; }
  function closeModal(back){ back.style.display = "none"; }

  document.getElementById("btnCreate").addEventListener("click", () => openModal(createBack));
  document.getElementById("btnForgot").addEventListener("click", () => openModal(forgotBack));

  document.getElementById("closeCreate").addEventListener("click", () => closeModal(createBack));
  document.getElementById("closeForgot").addEventListener("click", () => closeModal(forgotBack));

  // Close if click outside modal
  createBack.addEventListener("click", (e) => { if(e.target === createBack) closeModal(createBack); });
  forgotBack.addEventListener("click", (e) => { if(e.target === forgotBack) closeModal(forgotBack); });

  // ---- Sign in (validates against Google Sheet) ----
  document.getElementById("btnSignIn").addEventListener("click", async () => {
    clearMsg();

    const email = (document.getElementById("email").value || "").trim().toLowerCase();
    const pass  = document.getElementById("password").value || "";

    if(!email || !pass){
      showMsg("Please enter your email and password.", "err");
      return;
    }

    try {
      const data = await postAPI({ action: "login", email, password: pass });

      if(!data.ok){
        showMsg(data.error || "Login failed.", "err");
        return;
      }

      // Store prototype session
      localStorage.setItem("coresight_token", data.token || "");
      localStorage.setItem("coresight_user", JSON.stringify(data.user || {}));

      showMsg(`Welcome, ${data.user?.name || "User"}. Login successful.`, "ok");

      // Optional redirect (enable when dashboard.html exists)
      // window.location.href = "dashboard.html";

    } catch (e) {
      showMsg("Network/API error. Please try again.", "err");
    }
  });

  // ---- Create user (saves to Google Sheet) ----
  document.getElementById("btnSaveUser").addEventListener("click", async () => {
    const name  = (document.getElementById("newName").value || "").trim();
    const email = (document.getElementById("newEmail").value || "").trim().toLowerCase();
    const pass  = document.getElementById("newPass").value || "";

    if(!name || !email || !pass){
      alert("Please fill all fields.");
      return;
    }

    try {
      const data = await postAPI({ action: "signup", name, email, password: pass });

      if(!data.ok){
        alert(data.error || "Signup failed.");
        return;
      }

      closeModal(createBack);
      showMsg("Account created successfully. You can now sign in.", "ok");

      // prefill login
      document.getElementById("email").value = email;
      document.getElementById("password").value = pass;

      // clear modal fields
      document.getElementById("newName").value = "";
      document.getElementById("newEmail").value = "";
      document.getElementById("newPass").value = "";

    } catch (e) {
      alert("Network/API error. Please try again.");
    }
  });

  // ---- Forgot password (prototype message via API) ----
  document.getElementById("btnSendReset").addEventListener("click", async () => {
    const email = (document.getElementById("forgotEmail").value || "").trim().toLowerCase();
    if(!email){
      alert("Enter your email.");
      return;
    }

    try {
      const data = await postAPI({ action: "forgot", email });

      closeModal(forgotBack);
      showMsg(data.message || "If this email exists, reset instructions were sent (prototype).", "ok");
      document.getElementById("forgotEmail").value = "";

    } catch (e) {
      closeModal(forgotBack);
      showMsg("Network/API error. Please try again.", "err");
    }
  });
</script>
